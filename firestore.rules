/**
 * @file Firestore Security Rules
 * @description This ruleset enforces a role-based access control model, primarily based on user ownership and shop affiliation.
 *
 * Data Structure:
 * - /shops/{shopId}: Stores shop information, accessible primarily by shop owners and admins.
 * - /users/{userId}: Stores user information, accessible by the user themselves. Admins can read all user data.
 * - /shops/{shopId}/products/{productId}: Stores product information, accessible by shop owners.
 * - /shops/{shopId}/orders/{orderId}: Stores order information, accessible by shop owners.
 * - /payments/{paymentId}: Stores payment information.
 * - /audit_logs/{logId}: Stores audit logs, write-only for backend services.
 *
 * Key Security Decisions:
 * - Admins have read access to all shops and users.
 * - Users can only access their own user documents.
 * - Shop owners can manage their shops, products, and orders.
 * - Listing of users is generally disallowed for privacy, except for admins.
 * - Audit logs are write-only, ensuring data integrity.
 *
 * Denormalization for Authorization:
 * - The User document includes the `shopId` to avoid needing to query the Shop document for authorization checks.
 */
rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    function isAuth() {
      return request.auth != null;
    }

    function getUserData(userId) {
      return get(/databases/$(database)/documents/users/$(userId)).data;
    }

    function isAuthOwner(userId) {
      return isAuth() && request.auth.uid == userId;
    }

    function isAdmin() {
      return isAuth() && getUserData(request.auth.uid).role == 'admin';
    }

    /**
     * @description Allows admins or shop owners to manage their shop information.
     * @path /shops/{shopId}
     */
    match /shops/{shopId} {
      function isShopOwner() {
        return isAuth() && request.auth.uid == resource.data.ownerUserId;
      }
      allow get: if true;
      allow list: if isAuth();
      allow create: if isShopOwner() || isAdmin();
      allow update: if (isShopOwner() || isAdmin()) && resource != null;
      allow delete: if (isShopOwner() || isAdmin()) && resource != null;
    }

    /**
     * @description Allows users to manage their own user documents. Admins can read any user document.
     * @path /users/{userId}
     */
    match /users/{userId} {
      allow get: if isAuthOwner(userId) || isAdmin();
      allow list: if isAdmin();
      allow create: if isAuthOwner(userId);
      allow update: if isAuthOwner(userId) && resource != null;
      allow delete: if isAuthOwner(userId) && resource != null;
    }

    /**
     * @description Allows shop owners to manage products within their shops. Admins can also manage products.
     * @path /shops/{shopId}/products/{productId}
     */
    match /shops/{shopId}/products/{productId} {
      function isShopOwner(shopId) {
          return isAuth() && get(/databases/$(database)/documents/shops/$(shopId)).data.ownerUserId == request.auth.uid;
      }
      allow get, list: if true;
      allow create: if isShopOwner(shopId) || isAdmin();
      allow update: if (isShopOwner(shopId) || isAdmin()) && resource != null;
      allow delete: if (isShopOwner(shopId) || isAdmin()) && resource != null;
    }

    /**
     * @description Allows shop owners to manage orders within their shops. Admins can also manage orders.
     * @path /shops/{shopId}/orders/{orderId}
     */
    match /shops/{shopId}/orders/{orderId} {
       function isShopOwner(shopId) {
          return isAuth() && get(/databases/$(database)/documents/shops/$(shopId)).data.ownerUserId == request.auth.uid;
      }
      allow get, list: if true;
      allow create: if isShopOwner(shopId) || isAdmin();
      allow update: if (isShopOwner(shopId) || isAdmin()) && resource != null;
      allow delete: if (isShopOwner(shiopId) || isAdmin()) && resource != null;
    }

    /**
     * @description Allows read access to payments for authorized users. Admins can manage payments.
     * @path /payments/{paymentId}
     */
    match /payments/{paymentId} {
      allow get, list: if isAuth();
      allow create, update, delete: if isAdmin();
    }

    /**
     * @description Allows writing audit logs for tracking user activities. Read operations are denied.
     * @path /audit_logs/{logId}
     */
    match /audit_logs/{logId} {
      allow get, list, update, delete: if false;
      allow create: if isAuth();
    }
  }
}
