
rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {

    // Helper functions to check user roles and ownership
    function isSignedIn() {
      return request.auth != null;
    }

    function isOwner(userId) {
      return request.auth.uid == userId;
    }

    function getUserRole() {
      return get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role;
    }

    function isAdmin() {
      return isSignedIn() && getUserRole() == 'admin';
    }

    function isShopOwner(shopId) {
      let userDoc = get(/databases/$(database)/documents/users/$(request.auth.uid)).data;
      return isSignedIn() && userDoc.shopId == shopId && userDoc.role == 'owner';
    }
    
    function isShopMember(shopId) {
        let userDoc = get(/databases/$(database)/documents/users/$(request.auth.uid)).data;
        return isSignedIn() && userDoc.shopId == shopId && (userDoc.role == 'owner' || userDoc.role == 'staff');
    }

    // Rules for collections
    match /users/{userId} {
      // Admins can read/write any user. Users can read/write their own data.
      allow read, write: if isAdmin() || isOwner(userId);
      // Admins can list all users
      allow list: if isAdmin();
    }

    match /shops/{shopId} {
      // Admins can manage all shops. Shop owners can read their own shop.
      allow read, write: if isAdmin();
      allow read: if isShopOwner(shopId);
       // Admins can list all shops
      allow list: if isAdmin();
    }

    match /shops/{shopId}/products/{productId} {
      // Shop members can manage products for their shop.
      allow read, write: if isShopMember(shopId);
      allow list: if isShopMember(shopId);
    }

    match /shops/{shopId}/orders/{orderId} {
        // Shop members can manage orders for their shop.
        allow read, write: if isShopMember(shopId);
        allow list: if isShopMember(shopId);
    }

    match /audit_logs/{logId} {
      // Authenticated users can read logs, but only admins can create, update, or delete them.
      allow read: if isSignedIn();
      allow write: if isAdmin();
      allow list: if isSignedIn();
    }

    match /payments/{paymentId} {
        // Only admins should be able to view all payments for now
        allow read, write, list: if isAdmin();
    }
  }
}
